<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Choose the Preposition — игра</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="description" content="Игра для изучения предлогов английского языка" />
  <meta name="theme-color" content="#071026" />
  <link rel="manifest" href="/preposition_game/manifest.json" />
  <link rel="icon" type="image/png" sizes="192x192" href="/preposition_game/icon-192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="/preposition_game/icon-512.png" />
  <link rel="apple-touch-icon" href="/preposition_game/icon-192.png" />
  <style>
    :root{
      --bg:#071026; --card:#0b1220; --muted:#9fb6d2; --accent:#8ee6a4; --bad:#ff9b9b;
      --good:#9be7a2; --panel:#081224;
    }
    html,body{height:100%;margin:0;font-family:Inter, Roboto, Arial, sans-serif;background:linear-gradient(180deg,#021025,#041022);color:#e6eef8}
    .wrap{min-height:100%;display:flex;align-items:center;justify-content:center;padding:28px}
    .card{width:100%;max-width:500px;background:var(--card);border-radius:12px;padding:22px;box-shadow:0 10px 40px rgba(2,6,12,0.6)}
    h1{margin:0;font-size:20px;color:#dff1ff}
    .meta{display:flex;justify-content:space-between;align-items:center;margin-top:10px;gap:12px}
    .small{color:var(--muted);font-size:13px}
    .status{display:flex;gap:16px;align-items:center}
    .score{font-weight:700;color:var(--accent)}
    .panel{margin-top:16px;background:var(--panel);padding:16px;border-radius:10px}
    .sentence{font-size:20px;margin:0 0 12px 0}
    .options{display:flex;gap:10px}
    .opt{flex:1;padding:12px;border-radius:8px;background:#071226;border:1px solid rgba(255,255,255,0.03);text-align:center;cursor:pointer;user-select:none;transition:transform .07s,background .12s}
    .opt:hover{transform:translateY(-3px)}
    .opt.correct{background:linear-gradient(90deg,#063b22,#0a7a49);color:#ecfff3}
    .opt.wrong{background:linear-gradient(90deg,#4a1016,#7a1b25);color:#fff1f1}
    .hint{margin-top:12px;color:var(--muted);font-size:14px}
    .hintBox{margin-top:14px;padding:12px;border-radius:8px;background:#081822;border:1px solid rgba(255,255,255,0.02)}
    .controls{display:flex;gap:10px;justify-content:flex-end;margin-top:14px}
    .btn{padding:8px 12px;border-radius:8px;background:#08324f;border:1px solid rgba(255,255,255,0.03);color:#dff1ff;cursor:pointer}
    .btn:active{transform:translateY(1px)}
    .repeatBtn{background:#144b6a}
    footer{margin-top:12px;color:var(--muted);font-size:13px}
    .kbd{background:#0b2030;padding:4px 8px;border-radius:6px;border:1px solid rgba(255,255,255,0.03);font-size:13px}
    @media(max-width:540px){ .options{flex-direction:column} .card{padding:14px} .sentence{font-size:18px} }
    .opt:focus {
      outline: none;
      box-shadow: none;
    }
    .progress-container{margin-top:16px;position:relative;width:140px;height:140px;margin-left:auto;margin-right:auto}
    .progress-circle{position:absolute;width:100%;height:100%;transform:rotate(-90deg)}
    .progress-bar{position:absolute;width:3px;height:50%;background:rgba(255,255,255,0.08);border-radius:2px;transition:background 0.3s,opacity 0.3s;top:0;left:50%;transform-origin:bottom center;opacity:0.5}
    .progress-bar.filled{background:linear-gradient(180deg,var(--accent),#4aba76);opacity:1}
    .progress-bar.reset-anim{animation:resetBar 0.5s ease-out forwards}
    .progress-center{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:32px;font-weight:700;color:var(--accent);text-align:center;line-height:1;z-index:1}
    @keyframes resetBar{
      0%{background:linear-gradient(180deg,var(--bad),#9b4a4a);opacity:1}
      100%{background:rgba(255,255,255,0.08);opacity:0.5}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" role="application" aria-label="Choose the Preposition game">
      <h1>Choose the Preposition</h1>

      <div class="meta">
        <div class="small">Use mouse or keys <span class="kbd">1</span> <span class="kbd">2</span> <span class="kbd">3</span> <span class="kbd">Space</span></div>
        <div class="status">
          <div class="small">Progress: <span id="progressNum">0</span>/<span id="total">0</span></div>
          <div class="small">Best: <span id="best" class="score">0</span></div>
        </div>
      </div>

      <div class="progress-container">
        <div class="progress-circle" id="progressBars"></div>
        <div class="progress-center" id="progressCenter">0</div>
      </div>

      <div class="panel" id="gamePanel">
        <div id="sentence" class="sentence" aria-live="polite">Loading...</div>
        <div id="options" class="options" role="list"></div>

        <div id="hint" class="hint" aria-live="polite"></div>

        <div id="tipBlock" class="hintBox" style="display:none">
          <div id="tipText" style="font-weight:700;margin-bottom:8px;color:#ffdca3"></div>
          <div class="small" id="tipExplain" style="color:var(--muted)"></div>
          <div style="display:flex;justify-content:flex-end;margin-top:10px">
            <button id="repeatBtn" class="btn repeatBtn">Повторить</button>
          </div>
        </div>

        <div class="controls" style="margin-top:10px">
          <!-- intentionally no restart button -->
        </div>
      </div>

      <footer>Вопросы и варианты на английском. Подсказки — на русском, ориентированы на типичные ошибки.</footer>
    </div>
  </div>

<script src="questions.js"></script>
<script>
/* ====== State ====== */
let index = 0;                // текущий индекс вопроса (0..len-1)
let score = 0;                // текущая серия правильных подряд (для best)
const total = QUESTIONS.length;
const BEST_KEY = 'preposition_game_best';

/* ====== Elements ====== */
const sentenceEl = document.getElementById('sentence');
const optionsEl = document.getElementById('options');
const progressEl = document.getElementById('progressNum');
const totalEl = document.getElementById('total');
const bestEl = document.getElementById('best');
const hintEl = document.getElementById('hint');
const tipBlock = document.getElementById('tipBlock');
const tipText = document.getElementById('tipText');
const tipExplain = document.getElementById('tipExplain');
const repeatBtn = document.getElementById('repeatBtn');
const progressBarsEl = document.getElementById('progressBars');
const progressCenterEl = document.getElementById('progressCenter');

/* ====== Init UI ====== */
totalEl.textContent = total;
let best = parseInt(localStorage.getItem(BEST_KEY) || '0', 10);
bestEl.textContent = best;

// Initialize 100 progress bars in a circle
for(let i = 0; i < 100; i++){
  const bar = document.createElement('div');
  bar.className = 'progress-bar';
  const angle = (360 / 100) * i;
  bar.style.transform = `rotate(${angle}deg)`;
  progressBarsEl.appendChild(bar);
}

render();

/* ====== Shuffle helper ====== */
function shuffle(arr){
  const copy = [...arr];
  for(let i = copy.length - 1; i > 0; i--){
    const j = Math.floor(Math.random() * (i + 1));
    [copy[i], copy[j]] = [copy[j], copy[i]];
  }
  return copy;
}

/* ====== Update progress bars ====== */
function updateProgressBars(){
  const bars = progressBarsEl.children;
  for(let i = 0; i < bars.length; i++){
    if(i < score){
      bars[i].classList.add('filled');
    } else {
      bars[i].classList.remove('filled');
    }
  }
  // Update center counter
  progressCenterEl.textContent = score;
}

/* ====== Reset progress bars with animation ====== */
function resetProgressBars(){
  const bars = progressBarsEl.children;
  // Add reset animation to all filled bars
  for(let i = 0; i < bars.length; i++){
    if(bars[i].classList.contains('filled')){
      bars[i].classList.add('reset-anim');
    }
  }
  // Remove animation class and filled class after animation completes
  setTimeout(() => {
    for(let i = 0; i < bars.length; i++){
      bars[i].classList.remove('reset-anim', 'filled');
    }
  }, 500);
}

/* ====== Render question (with shuffling) ====== */
function render(){
  const q = QUESTIONS[index];
  // show progress: how many reached now (score) or show index? User wanted "до какого предложения добрался сейчас"
  // We'll show index (how many answered before current) — i.e., score is number of consecutive correct answers.
  progressEl.textContent = score;
  sentenceEl.textContent = `${q.before} ____ ${q.after}`;
  hintEl.textContent = ''; // small contextual hint removed unless necessary
  optionsEl.innerHTML = '';
  tipBlock.style.display = 'none';

  // shuffle options each time
  const shuffledOptions = shuffle(q.options);
  shuffledOptions.forEach((opt, i) => {
    const btn = document.createElement('div');
    btn.className = 'opt';
    btn.textContent = opt;
    btn.setAttribute('data-opt', opt);
    btn.tabIndex = 0;
    btn.addEventListener('click', () => choose(opt, btn));
    btn.addEventListener('keydown', (e) => { if(e.key === 'Enter' || e.key === ' ') choose(opt, btn); });
    optionsEl.appendChild(btn);
  });
}

/* ====== Choose handler ====== */
let canAnswer = true;
function choose(option, el){
  if(!canAnswer) return; // prevent answering when locked
  canAnswer = false; // lock immediately

  const q = QUESTIONS[index];
  if(option === q.correct){
    // correct
    el.classList.add('correct');
    score++;
    updateProgressBars(); // update progress bars
    // update best if needed
    if(score > best){
      best = score;
      localStorage.setItem(BEST_KEY, String(best));
      bestEl.textContent = best;
    } else {
      bestEl.textContent = best;
    }
    // move to next question modulo length, no victory
    index = (index + 1) % total;
    setTimeout(() => {
      canAnswer = true; // unlock for next question
      render();
    }, 100);
  } else {
    // wrong - keep locked until Repeat button pressed
    el.classList.add('wrong');
    resetProgressBars(); // animate reset of progress bars
    // highlight correct option visually
    Array.from(optionsEl.children).forEach(n => {
      if(n.getAttribute('data-opt') === q.correct) n.classList.add('correct');
    });
    // show tip block with Russian advice and explain
    tipText.textContent = q.tip || 'Совет по этой категории.';
    tipExplain.textContent = q.tipExplain || '';
    tipBlock.style.display = 'block';
    // reset score to 0 (user asked to reset on error) — but only after user presses Повторить
    // temporarily keep index as is to show which question caused error
    // store best persistently already handled
  }
}

/* ====== Repeat button: resets progress and starts from 0 ====== */
repeatBtn.addEventListener('click', () => {
  // reset run
  score = 0;
  index = 0;
  canAnswer = true; // unlock answering
  updateProgressBars(); // clear progress bars
  // hide tip and render first question
  tipBlock.style.display = 'none';
  render();
});

/* ====== Keyboard support 1/2/3 and Space ====== */
const pressedKeys = new Set();

window.addEventListener('keydown', (e) => {
  // Prevent action if key is already pressed (held down)
  if(pressedKeys.has(e.key)) return;
  pressedKeys.add(e.key);

  if(['1','2','3'].includes(e.key)){
    const idx = parseInt(e.key,10) - 1;
    const node = optionsEl.children[idx];
    if(node) node.click();
  } else if(e.key === ' '){
    e.preventDefault(); // prevent page scroll
    // Reset game to beginning
    score = 0;
    index = 0;
    canAnswer = true;
    updateProgressBars(); // clear progress bars
    tipBlock.style.display = 'none';
    render();
  }
});

window.addEventListener('keyup', (e) => {
  pressedKeys.delete(e.key);
});

/* ====== Accessibility: focus first option on render ====== */
const observer = new MutationObserver(() => {
  const first = optionsEl.children[0];
  if(first) first.focus();
});
observer.observe(optionsEl, { childList: true });

</script>

<script>
// Register Service Worker for PWA
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/preposition_game/sw.js')
      .then((registration) => {
        console.log('Service Worker registered:', registration.scope);
      })
      .catch((error) => {
        console.log('Service Worker registration failed:', error);
      });
  });
}
</script>
</body>
</html>
